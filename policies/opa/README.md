# CloudSentinel OPA Quality Gate

This policy layer is the single ALLOW/DENY decision point for shift-left scans.

## Contract

- Input: `.cloudsentinel/golden_report.json` generated by `shift-left/normalizer/normalize.sh`
- Policy: `pipeline_decision.rego`
- Exceptions data: `exceptions.json`
- Output query: `data.cloudsentinel.gate.decision`

## Decision Logic

- Deny if any scanner reports `NOT_RUN`
- Deny if `summary.global.CRITICAL` exceeds `quality_gate.thresholds.critical_max`
- Deny if `summary.global.HIGH` exceeds `quality_gate.thresholds.high_max`
- Apply scoped temporary exceptions only when:
  - `enabled=true`
  - ticket + approver are present
  - environment matches (`dev`/`test`/`staging`/`prod`)
  - exception is not expired
  - finding severity is less or equal to `max_severity`
- In `prod`, exceptions with `max_severity=CRITICAL` are rejected
- Allow only when no deny reason exists

## Exception Format

```json
{
  "cloudsentinel": {
    "exceptions": {
      "exceptions": [
        {
          "id": "EXC-2026-001",
          "enabled": true,
          "tool": "checkov",
          "rule_id": "CKV2_CS_AZ_003",
          "resource_path": "/main.tf",
          "environments": ["dev"],
          "max_severity": "HIGH",
          "reason": "Emergency unblock",
          "ticket": "SEC-4821",
          "approved_by": "security.lead@example.com",
          "created_at": "2026-02-21T10:00:00Z",
          "expires_at": "2026-02-24T10:00:00Z"
        }
      ]
    }
  }
}
```

`resource_path` is matched by exact path or suffix to handle normalized scanner paths.

## Local Validation

```bash
opa test policies/opa -v

opa eval \
  --input .cloudsentinel/golden_report.json \
  --data policies/opa/pipeline_decision.rego \
  --data policies/opa/exceptions.json \
  "data.cloudsentinel.gate.decision"
```
