# ============================================================================
# CloudSentinel - GitLab CI/CD
# Shift-Left scanners are advisory only. OPA is the single ALLOW/DENY gate.
# ============================================================================

variables:
  GITLEAKS_VERSION: "8.21.2"
  CHECKOV_VERSION: "3.2.502"
  TRIVY_VERSION: "0.69.1"
  OPA_VERSION: "1.13.1"
  OPA_IMAGE: "$CI_REGISTRY_IMAGE/opa:${OPA_VERSION}"
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

  SCAN_TARGET: "infra/azure/dev"
  TRIVY_TARGET: "infra/azure/dev"
  TRIVY_SCAN_TYPE: "config"

  CRITICAL_MAX: "0"
  HIGH_MAX: "2"

stages:
  - scan
  - normalize
  - decide
  - report
  - deploy

.default_tools: &default_tools
  image: python:3.11-bookworm
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends bash ca-certificates curl git jq tar gzip
    - rm -rf /var/lib/apt/lists/*
  cache:
    key: "cloudsentinel-tools"
    policy: pull-push
    paths:
      - .cache/pip
      - .cache/gitleaks
      - .cache/trivy

gitleaks-scan:
  <<: *default_tools
  stage: scan
  script:
    - mkdir -p "${CACHE_DIR}/gitleaks" .cloudsentinel
    - GITLEAKS_TARBALL="gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
    - GITLEAKS_CHECKSUMS="gitleaks_${GITLEAKS_VERSION}_checksums.txt"
    - |
      if [ ! -f "${CACHE_DIR}/gitleaks/${GITLEAKS_TARBALL}" ]; then
        curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/${GITLEAKS_TARBALL}" \
          -o "${CACHE_DIR}/gitleaks/${GITLEAKS_TARBALL}"
      fi
    - |
      if [ ! -f "${CACHE_DIR}/gitleaks/${GITLEAKS_CHECKSUMS}" ]; then
        curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/${GITLEAKS_CHECKSUMS}" \
          -o "${CACHE_DIR}/gitleaks/${GITLEAKS_CHECKSUMS}"
      fi
    - |
      cd "${CACHE_DIR}/gitleaks"
      grep " ${GITLEAKS_TARBALL}$" "${GITLEAKS_CHECKSUMS}" | sha256sum -c -
      cd -
    - tar -xzf "${CACHE_DIR}/gitleaks/${GITLEAKS_TARBALL}" -C /usr/local/bin gitleaks
    - chmod +x shift-left/gitleaks/run-gitleaks.sh
    - bash shift-left/gitleaks/run-gitleaks.sh || true
    - jq -r '"[scan-summary] gitleaks=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' .cloudsentinel/gitleaks_opa.json
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - .cloudsentinel/gitleaks_raw.json
      - .cloudsentinel/gitleaks_opa.json

checkov-scan:
  <<: *default_tools
  stage: scan
  script:
    - pip install "checkov==${CHECKOV_VERSION}"
    - chmod +x shift-left/checkov/run-checkov.sh
    - mkdir -p .cloudsentinel
    - bash shift-left/checkov/run-checkov.sh "${SCAN_TARGET}" || true
    - jq -r '"[scan-summary] checkov=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' .cloudsentinel/checkov_opa.json
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - .cloudsentinel/checkov_raw.json
      - .cloudsentinel/checkov_opa.json
      - .cloudsentinel/checkov_scan.log

trivy-scan:
  <<: *default_tools
  stage: scan
  script:
    - mkdir -p "${CACHE_DIR}/trivy" shift-left/trivy/reports/raw shift-left/trivy/reports/opa
    - TRIVY_TARBALL="trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
    - TRIVY_CHECKSUMS="trivy_${TRIVY_VERSION}_checksums.txt"
    - |
      if [ ! -f "${CACHE_DIR}/trivy/${TRIVY_TARBALL}" ]; then
        curl -sSL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/${TRIVY_TARBALL}" \
          -o "${CACHE_DIR}/trivy/${TRIVY_TARBALL}"
      fi
    - |
      if [ ! -f "${CACHE_DIR}/trivy/${TRIVY_CHECKSUMS}" ]; then
        curl -sSL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/${TRIVY_CHECKSUMS}" \
          -o "${CACHE_DIR}/trivy/${TRIVY_CHECKSUMS}"
      fi
    - |
      cd "${CACHE_DIR}/trivy"
      grep " ${TRIVY_TARBALL}$" "${TRIVY_CHECKSUMS}" | sha256sum -c -
      cd -
    - tar -xzf "${CACHE_DIR}/trivy/${TRIVY_TARBALL}" -C /usr/local/bin trivy
    - chmod +x shift-left/trivy/scripts/run-trivy.sh
    - bash shift-left/trivy/scripts/run-trivy.sh "${TRIVY_TARGET}" "${TRIVY_SCAN_TYPE}" || true
    - jq -r '"[scan-summary] trivy=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' shift-left/trivy/reports/opa/trivy_opa.json
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - shift-left/trivy/reports/raw/
      - shift-left/trivy/reports/opa/trivy_opa.json

normalize-reports:
  <<: *default_tools
  stage: normalize
  needs:
    - job: gitleaks-scan
      artifacts: true
    - job: checkov-scan
      artifacts: true
    - job: trivy-scan
      artifacts: true
  script:
    - chmod +x shift-left/normalizer/normalize.sh
    - export ENVIRONMENT="${CI_ENVIRONMENT_NAME:-dev}"
    - export CLOUDSENTINEL_EXECUTION_MODE="ci"
    - bash shift-left/normalizer/normalize.sh
    - jq '.summary' .cloudsentinel/golden_report.json
    - jq '.quality_gate' .cloudsentinel/golden_report.json
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - .cloudsentinel/golden_report.json
      - .cloudsentinel/gitleaks_opa.json
      - .cloudsentinel/checkov_opa.json
      - shift-left/trivy/reports/opa/trivy_opa.json

opa-decision:
  image: "$OPA_IMAGE"
  stage: decide
  needs:
    - job: normalize-reports
      artifacts: true
  script:
    - opa test policies/opa -v
    - |
      opa run --server --addr=127.0.0.1:8181 \
        --log-level=info \
        --log-format=json \
        --set=decision_logs.console=true \
        policies/opa/pipeline_decision.rego \
        policies/opa/exceptions.json \
        > /tmp/opa-server.log 2>&1 &
    - sleep 1
    - curl -sf "http://127.0.0.1:8181/health" >/dev/null
    - OPA_SERVER_URL="http://127.0.0.1:8181" bash shift-left/opa/run-opa.sh --enforce
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - .cloudsentinel/opa_decision.json

upload-to-defectdojo:
  stage: report
  image: curlimages/curl:8.12.1
  needs:
    - job: gitleaks-scan
      artifacts: true
    - job: checkov-scan
      artifacts: true
    - job: trivy-scan
      artifacts: true
  script:
    - |
      if [ -z "${DOJO_URL:-}" ] || [ -z "${DOJO_API_KEY:-}" ] || [ -z "${DOJO_ENGAGEMENT_ID:-}" ]; then
        echo "[dojo] Missing DOJO_URL / DOJO_API_KEY / DOJO_ENGAGEMENT_ID. Skipping upload."
        exit 0
      fi

      if [ -f ".cloudsentinel/gitleaks_raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@.cloudsentinel/gitleaks_raw.json" \
          -F "scan_type=Gitleaks Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Gitleaks uploaded"
      fi

      if [ -f ".cloudsentinel/checkov_raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@.cloudsentinel/checkov_raw.json" \
          -F "scan_type=Checkov Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Checkov uploaded"
      fi

      if [ -f "shift-left/trivy/reports/raw/trivy-config-raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@shift-left/trivy/reports/raw/trivy-config-raw.json" \
          -F "scan_type=Trivy Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Trivy uploaded"
      fi
  when: always
  allow_failure: true

deploy-infrastructure:
  stage: deploy
  <<: *default_tools
  needs:
    - job: opa-decision
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends gpg
    - rm -rf /var/lib/apt/lists/*
    - curl --proto '=https' --tlsv1.2 -fsSL https://get.opentofu.org/install-opentofu.sh -o /tmp/install-opentofu.sh
    - chmod +x /tmp/install-opentofu.sh
    - /tmp/install-opentofu.sh --install-method standalone --install-path /usr/local/bin
    - tofu version
    - cd infra/azure/dev
  script:
    - tofu init
    - tofu plan -out=tfplan
    - tofu apply -auto-approve tfplan
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - when: manual
