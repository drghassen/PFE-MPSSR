# ============================================================================
# CloudSentinel - GitLab CI/CD
# Shift-Left scanners are advisory only. OPA is the single ALLOW/DENY gate.
# ============================================================================

variables:
  GITLEAKS_VERSION: "8.21.2"
  CHECKOV_VERSION: "3.2.502"
  TRIVY_VERSION: "0.69.1"
  OPA_VERSION: "1.13.1"

  SCAN_TARGET: "infra/azure/dev"
  TRIVY_TARGET: "infra/azure/dev"
  TRIVY_SCAN_TYPE: "config"

  CRITICAL_MAX: "0"
  HIGH_MAX: "2"

stages:
  - scan
  - normalize
  - decide
  - report
  - deploy

.default_tools: &default_tools
  image: python:3.11-bookworm
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends bash ca-certificates curl git jq tar gzip
    - rm -rf /var/lib/apt/lists/*

shift-left-scan:
  <<: *default_tools
  stage: scan
  script:
    - pip install --no-cache-dir "checkov==${CHECKOV_VERSION}"
    - curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz -C /usr/local/bin gitleaks
    - curl -sSL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" | tar -xz -C /usr/local/bin trivy
    - chmod +x shift-left/gitleaks/run-gitleaks.sh shift-left/checkov/run-checkov.sh shift-left/trivy/scripts/run-trivy.sh
    - mkdir -p .cloudsentinel shift-left/trivy/reports/raw shift-left/trivy/reports/opa
    - bash shift-left/gitleaks/run-gitleaks.sh || true
    - bash shift-left/checkov/run-checkov.sh "${SCAN_TARGET}" || true
    - bash shift-left/trivy/scripts/run-trivy.sh "${TRIVY_TARGET}" "${TRIVY_SCAN_TYPE}" || true
    - jq -r '"[scan-summary] gitleaks=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' .cloudsentinel/gitleaks_opa.json
    - jq -r '"[scan-summary] checkov=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' .cloudsentinel/checkov_opa.json
    - jq -r '"[scan-summary] trivy=" + ((.stats.TOTAL // 0) | tostring) + " status=" + (.status // "unknown")' shift-left/trivy/reports/opa/trivy_opa.json
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - .cloudsentinel/gitleaks_raw.json
      - .cloudsentinel/gitleaks_opa.json
      - .cloudsentinel/checkov_raw.json
      - .cloudsentinel/checkov_opa.json
      - shift-left/trivy/reports/raw/
      - shift-left/trivy/reports/opa/trivy_opa.json

normalize-reports:
  <<: *default_tools
  stage: normalize
  needs:
    - job: shift-left-scan
      artifacts: true
  script:
    - chmod +x shift-left/normalizer/normalize.sh
    - export ENVIRONMENT="${CI_ENVIRONMENT_NAME:-dev}"
    - bash shift-left/normalizer/normalize.sh
    - jq '.summary' .cloudsentinel/golden_report.json
    - jq '.quality_gate' .cloudsentinel/golden_report.json
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - .cloudsentinel/golden_report.json
      - .cloudsentinel/gitleaks_opa.json
      - .cloudsentinel/checkov_opa.json
      - shift-left/trivy/reports/opa/trivy_opa.json

opa-decision:
  <<: *default_tools
  stage: decide
  needs:
    - job: normalize-reports
      artifacts: true
  script:
    - curl -sSL "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static" -o /usr/local/bin/opa
    - chmod +x /usr/local/bin/opa
    - opa test policies/opa -v
    - opa eval --format json --input .cloudsentinel/golden_report.json --data policies/opa/pipeline_decision.rego --data policies/opa/exceptions.json "data.cloudsentinel.gate.decision" > .cloudsentinel/opa_decision.json
    - ALLOW=$(jq -r '.result[0].expressions[0].value.allow // false' .cloudsentinel/opa_decision.json)
    - EXC_COUNT=$(jq -r '.result[0].expressions[0].value.exceptions.applied_count // 0' .cloudsentinel/opa_decision.json)
    - EXC_IDS=$(jq -r '.result[0].expressions[0].value.exceptions.applied_ids // [] | join(",")' .cloudsentinel/opa_decision.json)
    - echo "[opa] exceptions_applied=${EXC_COUNT}"
    - '[ -n "$EXC_IDS" ] && echo "[opa] exception_ids=${EXC_IDS}" || true'
    - |
      if [ "$ALLOW" = "true" ]; then
        echo "[opa] STATUS=ALLOWED"
        exit 0
      fi
      echo "[opa] STATUS=DENIED"
      jq -r '.result[0].expressions[0].value.deny[]?' .cloudsentinel/opa_decision.json | sed 's/^/[opa] reason: /'
      exit 1
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - .cloudsentinel/opa_decision.json

upload-to-defectdojo:
  stage: report
  image: curlimages/curl:8.12.1
  needs:
    - job: shift-left-scan
      artifacts: true
  script:
    - |
      if [ -z "${DOJO_URL:-}" ] || [ -z "${DOJO_API_KEY:-}" ] || [ -z "${DOJO_ENGAGEMENT_ID:-}" ]; then
        echo "[dojo] Missing DOJO_URL / DOJO_API_KEY / DOJO_ENGAGEMENT_ID. Skipping upload."
        exit 0
      fi

      if [ -f ".cloudsentinel/gitleaks_raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@.cloudsentinel/gitleaks_raw.json" \
          -F "scan_type=Gitleaks Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Gitleaks uploaded"
      fi

      if [ -f ".cloudsentinel/checkov_raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@.cloudsentinel/checkov_raw.json" \
          -F "scan_type=Checkov Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Checkov uploaded"
      fi

      if [ -f "shift-left/trivy/reports/raw/trivy-config-raw.json" ]; then
        curl -sS -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_API_KEY}" \
          -F "file=@shift-left/trivy/reports/raw/trivy-config-raw.json" \
          -F "scan_type=Trivy Scan" \
          -F "engagement=${DOJO_ENGAGEMENT_ID}" \
          -F "active=true" -F "verified=false" >/dev/null
        echo "[dojo] Trivy uploaded"
      fi
  when: always
  allow_failure: true

deploy-infrastructure:
  stage: deploy
  <<: *default_tools
  needs:
    - job: opa-decision
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends gpg
    - rm -rf /var/lib/apt/lists/*
    - curl --proto '=https' --tlsv1.2 -fsSL https://get.opentofu.org/install-opentofu.sh -o /tmp/install-opentofu.sh
    - chmod +x /tmp/install-opentofu.sh
    - /tmp/install-opentofu.sh --install-method standalone --install-path /usr/local/bin
    - tofu version
    - cd infra/azure/dev
  script:
    - tofu init
    - tofu plan -out=tfplan
    - tofu apply -auto-approve tfplan
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - when: manual
